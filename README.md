# vk2tg

Сервис на Go, который синхронизирует стену выбранной VK-группы с Telegram-каналом: пересылает новые публикации, хранит состояние в Postgres и редактирует сообщения, если исходный пост во VK изменился.

## Возможности

- Обращается к `wall.get`, сортирует посты и пересылает их в Telegram в правильном порядке.
- Поддерживает текст и фото (включая альбомы), добавляет ссылку на оригинальный пост.
- Хранит посты в таблицах `vk_post` и `tg_post`, использует хэши для дедупликации.
- При изменении контента на стороне VK обновляет опубликованное сообщение через `editMessageText` / `editMessageCaption`.
- Управляет токенами VK ID: получает их через встроенную страницу авторизации и автоматически обновляет по истечении срока.

## Требования

- Go 1.22+
- Postgres 13+ (миграции применяются автоматически с помощью goose)
- VK ID приложение с включённым OneTap (client_id `54260965` используется в репозитории)
- Telegram бот с правами администратора в целевом канале или форуме

## Конфигурация

Перед запуском задайте переменные окружения:

| Переменная        | Назначение                                                                 |
|-------------------|----------------------------------------------------------------------------|
| `DB_HOST`         | Хост Postgres                                                              |
| `DB_PORT`         | Порт Postgres                                                              |
| `DB_USERNAME`     | Пользователь                                                              |
| `DB_PASSWORD`     | Пароль                                                                     |
| `DB_DATABASE`     | Имя базы данных                                                            |
| `DB_SCHEMA`       | Схема, в которую применяются миграции                                     |
| `VK_GROUP_ID`     | Числовой ID группы без минуса (`public123` → `123`)                        |
| `TG_BOT_TOKEN`    | Токен Telegram-бота                                                        |
| `TG_CHANNEL_ID`   | ID канала / чата (можно `-100…` или `@username`)                           |
| `TG_THREAD_ID`    | (опционально) ID ветки в обсуждении канала                                 |
| `PORT`            | (опционально) HTTP-порт, по умолчанию `8080`                               |
| `INDEX_HTML_PATH` | (опционально) Путь к кастомному index.html                                 |

Прочие переменные, такие как `TG_THREAD_ID`, можно опустить, если не нужны обсуждения.

## Запуск

```bash
export DB_HOST=127.0.0.1
export DB_PORT=5432
export DB_USERNAME=vk2tg
export DB_PASSWORD=secret
export DB_DATABASE=vk2tg
export DB_SCHEMA=public
export VK_GROUP_ID=123456
export TG_BOT_TOKEN="12345:ABC..."
export TG_CHANNEL_ID="-1001234567890"

go run ./cmd/vk2tg
```

После старта приложение:

1. Проверяет соединение с Postgres и применяет миграции.
2. Запускает HTTP-сервер (по умолчанию `:8080`), отдающий `index.html`.
3. Стартует воркер, который каждые 5 минут синхронизирует VK → Telegram.

Чтобы загрузить access/refresh токены VK, откройте `http://localhost:8080`, авторизуйтесь через VK ID OneTap и дождитесь подтверждения.

## Проверка

```bash
go test ./...
```

Тестов пока немного; ключевая логика завязана на внешние API, поэтому для регрессионных проверок рекомендуется запускать интеграционные тесты на стенде.

## Развёртывание

Для Kubernetes/Helm см. примеры манифестов в `deploy/`. Секреты передаются через `deploy/templates/secret.yaml`, убедитесь, что значения соответствуют переменным окружения из раздела «Конфигурация».
